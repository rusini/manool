# .github/workflows/cross.yaml

name: Cross-Build

on:
  workflow_dispatch: {}
  push:
    branches: [ test ]

jobs:
  build:

    strategy:
      fail-fast: false
      matrix:
        platform:
        - { label: "aarch64-linux-gnu",            flags: ""; dynlinker: "/lib/ld-linux-aarch64.so.1" }
        - { label: "arm-linux-gnueabihf",          flags: "" }
        - { label: "powerpc64le-linux-gnu",        flags: "" }
        - { label: "powerpc-linux-gnu",            flags: "-mlittle-endian" }
        - { label: "riscv64-linux-gnu",            flags: "" }
        - { label: "mipsel-linux-gnu",             flags: "" } # up to 10
        - { label: "mips64el-linux-gnuabi64",      flags: "" } # up to 10
        - { label: "mipsisa32r6el-linux-gnu",      flags: "" } # up to 10
        - { label: "mipsisa64r6el-linux-gnuabi64", flags: "" } # up to 10
        - { label: "alpha-linux-gnu",              flags: "" }
        - { label: "sh4-linux-gnu",                flags: "" }
        compiler:
        - { ver: "8",  osver: "20.04" }
        - { ver: "9",  osver: "20.04" }
        - { ver: "10", osver: "22.04" }
        - { ver: "11", osver: "22.04" }
        - { ver: "12", osver: "22.04" }
        exclude:
        - platform: { label: "mipsel-linux-gnu" }
          compiler: { ver:   "9"  }
        - platform: { label: "mipsel-linux-gnu" }
          compiler: { ver:   "11" }
        - platform: { label: "mipsel-linux-gnu" }
          compiler: { ver:   "12" }
        - platform: { label: "mips64el-linux-gnu" }
          compiler: { ver:   "9"  }
        - platform: { label: "mips64el-linux-gnu" }
          compiler: { ver:   "11" }
        - platform: { label: "mips64el-linux-gnu" }
          compiler: { ver:   "12" }
        - platform: { label: "mipsisa32r6el-linux-gnu" }
          compiler: { ver:   "9"  }
        - platform: { label: "mipsisa32r6el-linux-gnu" }
          compiler: { ver:   "11" }
        - platform: { label: "mipsisa32r6el-linux-gnu" }
          compiler: { ver:   "12" }
        - platform: { label: "mipsisa64r6el-linux-gnu" }
          compiler: { ver:   "9"  }
        - platform: { label: "mipsisa64r6el-linux-gnu" }
          compiler: { ver:   "11" }
        - platform: { label: "mipsisa64r6el-linux-gnu" }
          compiler: { ver:   "12" }
    name: Build with ${{matrix.platform.label}}-gcc-${{matrix.compiler.ver}}
    runs-on: ubuntu-${{matrix.compiler.osver}}

    defaults:
      run:
        shell: bash

    steps:

    - name: Machine Information
      run: |
        lscpu; free -h; df -h .
    - name: System Information
      run: |
        date; uname -a; uptime; cat /etc/os-release; ls -C /boot || :
    - name: Context Information
      run: |
        tty || :; id; printf %s\\n "$SHELL"; printf %s\\n "$PATH"; pwd

    - name: Update Package DB
      run: sudo apt-get update
    - name: Install QEMU
      run: sudo apt-get install qemu-user-static
    - name: Install GCC
      run: sudo apt-get install g++-${{matrix.compiler.ver}}-${{matrix.platform.label}}

    - name: Build Tools Information
      run: |
        make --version; ${{matrix.platform.label}}-gcc-${{matrix.compiler.ver}} --version

    - name: Checkout
      uses: actions/checkout@v4

    - name: Run Make
      run: |
        make -j3 \
           GCC='${{matrix.platform.label}}-gcc-${{matrix.compiler.ver}}' \
           GXX='${{matrix.platform.label}}-g++-${{matrix.compiler.ver}}' \
           MARCH='${{matrix.platform.flags}}'
      #continue-on-error: true

    - run: ldd build/mnlexec

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: build-gcc-${{matrix.compiler.ver}}-${{matrix.platform.label}}
        path: build
